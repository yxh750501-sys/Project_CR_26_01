<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.demo.repository.ChecklistRepository">

  <select id="getRunInfoForResult" resultType="map">
    SELECT
      r.id            AS runId,
      r.memberId      AS memberId,
      r.childId       AS childId,
      ch.name         AS childName,
      r.checklistId   AS checklistId,
      cl.title        AS checklistTitle,
      r.createdAt     AS createdAt
    FROM checklist_runs r
    INNER JOIN children ch ON ch.id = r.childId
    INNER JOIN checklists cl ON cl.id = r.checklistId
    WHERE r.id = #{runId}
      AND r.memberId = #{memberId}
  </select>

  <select id="getDomainStatsByRunId" resultType="com.example.demo.vo.DomainStat">
    SELECT
      q.domainCode                        AS domainCode,
      IFNULL(SUM(a.answerValue), 0)       AS totalScore,
      IFNULL(AVG(a.answerValue), 0)       AS avgScore,
      COUNT(*)                            AS questionCount
    FROM checklist_answers a
    INNER JOIN checklist_questions q ON q.id = a.questionId
    WHERE a.runId = #{runId}
    GROUP BY q.domainCode
    ORDER BY avgScore DESC, totalScore DESC
  </select>

</mapper>