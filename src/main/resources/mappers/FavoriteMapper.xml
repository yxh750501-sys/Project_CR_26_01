<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.demo.repository.FavoriteRepository">

  <!-- 즐겨찾기 추가 — UNIQUE 충돌 시 silently 무시 (idempotent) -->
  <insert id="add">
    INSERT IGNORE INTO favorites (member_id, center_id)
    VALUES (#{memberId}, #{centerId})
  </insert>

  <!-- 즐겨찾기 해제 -->
  <delete id="remove">
    DELETE FROM favorites
    WHERE member_id = #{memberId}
      AND center_id = #{centerId}
  </delete>

  <!-- 즐겨찾기 여부 확인 -->
  <select id="exists" resultType="boolean">
    SELECT EXISTS (
      SELECT 1 FROM favorites
      WHERE member_id = #{memberId}
        AND center_id = #{centerId}
    )
  </select>

  <!-- 즐겨찾기 센터 ID 목록 (favoriteCenterIds 생성용) -->
  <select id="findCenterIdsByMember" resultType="long">
    SELECT center_id
    FROM favorites
    WHERE member_id = #{memberId}
  </select>

  <!--
    즐겨찾기 센터 전체 조회.
    CenterRepositoryMapper 의 centerFlatResultMap을 cross-namespace 참조.
    therapyTypeCodes: GROUP_CONCAT으로 쉼표 구분 문자열 반환.
  -->
  <select id="findFavoriteCentersByMember"
          resultMap="com.example.demo.repository.CenterRepository.centerFlatResultMap">
    SELECT
      c.id          AS id,
      c.name        AS name,
      c.center_type AS centerType,
      c.phone       AS phone,
      c.website     AS website,
      c.sido        AS sido,
      c.sigungu     AS sigungu,
      c.address     AS address,
      c.description AS description,
      c.is_active   AS isActive,
      c.reg_date    AS regDate,
      c.update_date AS updateDate,
      GROUP_CONCAT(DISTINCT cs.therapy_type_code ORDER BY cs.therapy_type_code) AS therapyTypeCodes
    FROM favorites f
    INNER JOIN centers c ON c.id = f.center_id AND c.is_active = 1
    LEFT JOIN center_services cs ON cs.center_id = c.id
    WHERE f.member_id = #{memberId}
    GROUP BY
      c.id, c.name, c.center_type, c.phone, c.website,
      c.sido, c.sigungu, c.address, c.description, c.is_active,
      c.reg_date, c.update_date
    ORDER BY f.reg_date DESC
  </select>

</mapper>
