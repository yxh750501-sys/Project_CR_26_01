<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.demo.repository.ChecklistRepository">

  <select id="getRunInfoForResult" resultType="map">
    SELECT
      r.id            AS runId,
      r.user_id       AS userId,
      r.child_id      AS childId,
      ch.name         AS childName,
      r.checklist_id  AS checklistId,
      cl.title        AS checklistTitle,
      r.reg_date      AS createdAt
    FROM checklist_runs r
    INNER JOIN children ch ON ch.id = r.child_id
    INNER JOIN checklists cl ON cl.id = r.checklist_id
    WHERE r.id = #{runId}
      AND r.user_id = #{memberId}
  </select>

  <select id="getDomainStatsByRunId" resultType="com.example.demo.vo.DomainStat">
    SELECT
      q.domain_code                       AS domainCode,
      COUNT(*)                            AS cnt,
      IFNULL(SUM(a.score), 0)             AS sumScore,
      IFNULL(AVG(a.score), 0)             AS avgScore
    FROM checklist_answers a
    INNER JOIN checklist_questions q ON q.id = a.question_id
    WHERE a.run_id = #{runId}
    GROUP BY q.domain_code
    ORDER BY avgScore ASC, sumScore ASC
  </select>

</mapper>
